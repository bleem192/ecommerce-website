# 阿里云云效CI/CD配置指南

## 1. 云效平台准备

### 1.1 注册与登录
1. 访问阿里云云效官网：https://www.aliyun.com/product/yunxiao
2. 使用阿里云账号登录云效平台

### 1.2 创建团队与项目
1. 创建新团队或加入现有团队
2. 在团队中创建新项目：
   - 项目类型：软件开发项目
   - 项目名称：ecommerce-demo
   - 项目描述：电商网站CI/CD自动化部署

## 2. 代码源配置

### 2.1 关联代码仓库
1. 进入项目后，点击左侧菜单「代码」→「代码仓库」
2. 点击「关联外部仓库」
3. 选择代码托管平台（GitHub/GitLab/Gitee等）
4. 按照提示授权并选择要关联的仓库

### 2.2 分支管理配置
1. 进入代码仓库设置
2. 配置分支保护规则：
   - 保护主分支（main/master）
   - 要求合并请求前必须通过CI/CD检查

## 3. 流水线配置

### 3.1 创建流水线
1. 点击左侧菜单「流水线」→「创建流水线」
2. 选择流水线模板：自定义流水线
3. 填写流水线基本信息：
   - 流水线名称：ecommerce-deployment
   - 描述：电商网站自动化部署流水线

### 3.2 配置流水线阶段

#### 3.2.1 阶段1：代码源
1. 选择已关联的代码仓库
2. 选择触发分支：main
3. 配置触发方式：
   - 手动触发
   - 代码提交触发
   - 合并请求触发

#### 3.2.2 阶段2：构建
1. 添加「构建」任务
2. 选择构建环境：Maven
3. 配置构建命令：
   ```bash
   cd ecommerce
   mvn clean package -DskipTests
   ```

#### 3.2.3 阶段3：Docker镜像构建
1. 添加「Docker构建推送」任务
2. 选择Dockerfile路径：ecommerce/Dockerfile
3. 配置镜像名称：ecommerce-app
4. 选择镜像仓库：
   - 可使用阿里云容器镜像服务(ACR)
   - 或本地镜像保存

#### 3.2.4 阶段4：部署到ECS
1. 添加「主机部署」任务
2. 配置ECS服务器：
   - 服务器组：新建服务器组
   - 服务器IP：ECS实例公网IP
   - 端口：22
   - 认证方式：密码或密钥

3. 配置部署脚本：
   ```bash
   # 进入应用目录
   cd /home/ecommerce
   
   # 启动服务
   docker-compose up -d
   ```

## 4. 变量管理

### 4.1 配置全局变量
1. 点击左侧菜单「项目设置」→「变量管理」
2. 添加以下全局变量：
   - `ALIYUN_ECS_IP`：ECS实例公网IP（类型：加密）
   - `ALIYUN_ECS_PASSWORD`：ECS服务器密码（类型：加密）
   - `MYSQL_ROOT_PASSWORD`：数据库密码（类型：加密）

### 4.2 配置环境变量
1. 在流水线配置中，为不同阶段配置环境变量
2. 确保敏感信息使用加密变量

## 5. 流水线测试

### 5.1 手动触发测试
1. 进入流水线详情页
2. 点击「运行流水线」
3. 选择分支和参数
4. 点击「确定」开始运行

### 5.2 检查流水线执行结果
1. 查看各阶段的执行日志
2. 检查是否有错误信息
3. 验证部署结果：
   ```bash
   # 登录ECS服务器
   ssh root@your-ecs-ip
   
   # 查看容器运行状态
   docker-compose ps
   
   # 查看应用日志
   docker logs -f ecommerce-app
   ```

## 6. 自动化触发配置

### 6.1 代码提交触发
1. 进入流水线配置
2. 点击「触发规则」
3. 开启「代码提交触发」
4. 选择要触发的分支

### 6.2 合并请求触发
1. 进入流水线配置
2. 点击「触发规则」
3. 开启「合并请求触发」
4. 配置触发条件（如：所有合并请求必须通过CI/CD检查）

## 7. 常见问题排查

### 7.1 构建失败
- 检查Maven依赖是否正确
- 检查代码是否有编译错误
- 查看构建日志获取详细错误信息

### 7.2 Docker镜像构建失败
- 检查Dockerfile语法是否正确
- 检查Docker服务是否正常运行
- 检查网络连接是否正常

### 7.3 部署失败
- 检查ECS服务器连接信息是否正确
- 检查安全组是否开放必要端口
- 检查部署脚本语法是否正确
- 查看ECS服务器上的日志文件

## 8. 优化建议

### 8.1 镜像仓库优化
- 使用阿里云容器镜像服务(ACR)存储Docker镜像
- 配置镜像加速，提高构建和部署速度

### 8.2 流水线优化
- 并行执行独立任务，提高构建效率
- 配置缓存，减少重复下载依赖的时间
- 实现蓝绿部署或金丝雀发布，降低部署风险

### 8.3 监控与告警
- 配置应用监控，实时监控应用运行状态
- 配置流水线执行结果告警，及时发现部署问题
- 配置服务器监控，监控ECS服务器资源使用情况

## 9. 高级配置

### 9.1 多环境部署
- 创建测试环境、预发环境、生产环境的流水线
- 配置环境间的自动部署规则

### 9.2 回滚配置
- 在流水线中配置回滚任务
- 实现一键回滚到指定版本

### 9.3 集成测试
- 在流水线中添加集成测试阶段
- 确保代码质量和功能正确性

---

**配置完成后，您的电商网站将实现自动化构建和部署，每次代码提交都会触发CI/CD流水线，自动完成测试、构建和部署流程。**
